<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistente Jur√≠dico DPE-BA (Com Upload)</title>
    <style>
        /* Estilo visual limpo e profissional */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef2f5; display: flex; justify-content: center; height: 100vh; margin: 0; }
        .chat-container { width: 90%; max-width: 900px; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 90vh; margin-top: 5vh; border-radius: 15px; overflow: hidden; position: relative; }
        
        /* Header */
        .header { background: linear-gradient(135deg, #005a34 0%, #004d2c 100%); color: white; padding: 20px; display: flex; align-items: center; justify-content: space-between; }
        .header h1 { margin: 0; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .btn-clear { background: rgba(255,255,255,0.2); border: none; padding: 5px 12px; color: white; cursor: pointer; border-radius: 6px; font-size: 0.85rem; transition: background 0.2s; }
        .btn-clear:hover { background: rgba(255,255,255,0.3); }

        /* √Årea de Mensagens */
        .messages { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; background-color: #fafafa; }
        .message { max-width: 80%; padding: 18px; border-radius: 12px; line-height: 1.6; font-size: 0.95rem; position: relative; word-wrap: break-word; }
        .user { align-self: flex-end; background-color: #005a34; color: white; border-bottom-right-radius: 2px; box-shadow: 0 2px 5px rgba(0,90,52,0.2); }
        .bot { align-self: flex-start; background-color: #ffffff; color: #333; border: 1px solid #e0e0e0; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* √Årea de Input */
        .footer-area { background: #fff; border-top: 1px solid #eee; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        /* Preview do Arquivo */
        .file-preview { display: none; align-items: center; gap: 10px; background-color: #e3f2fd; color: #0d47a1; padding: 8px 15px; border-radius: 8px; font-size: 0.9rem; align-self: flex-start; border: 1px solid #bbdefb; }
        .file-preview button { background: none; border: none; color: #d32f2f; cursor: pointer; font-weight: bold; font-size: 1.1rem; padding: 0 5px; }

        .input-row { display: flex; gap: 10px; align-items: center; }
        
        /* Bot√£o de Anexo (Clipe) */
        .attach-btn { cursor: pointer; padding: 12px; color: #666; transition: color 0.2s, background 0.2s; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .attach-btn:hover { background-color: #f5f5f5; color: #005a34; }
        .attach-btn svg { width: 24px; height: 24px; }

        input[type="text"] { flex: 1; padding: 15px 20px; border: 2px solid #e0e0e0; border-radius: 12px; outline: none; font-size: 16px; transition: border-color 0.3s; }
        input[type="text"]:focus { border-color: #005a34; }
        
        button#btnSend { padding: 0 25px; height: 50px; background-color: #005a34; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 16px; transition: transform 0.1s, background 0.2s; display: flex; align-items: center; gap: 8px; }
        button#btnSend:hover { background-color: #004529; }
        button#btnSend:active { transform: scale(0.98); }
        button:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }

        /* Formata√ß√£o das fontes e loading */
        .sources-box { margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; font-size: 0.85em; color: #555; }
        .source-tag { display: inline-block; background: #f0f4f8; padding: 4px 8px; border-radius: 4px; margin: 2px; border: 1px solid #dbe2e8; font-family: monospace; font-size: 0.8em; }
        
        .loading { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.9); padding: 8px 20px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 0.9rem; color: #005a34; font-weight: 600; display: none; align-items: center; gap: 8px; pointer-events: none; border: 1px solid #e0e0e0; }
        .loading::after { content: ""; width: 12px; height: 12px; border: 2px solid #005a34; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="header">
        <h1>‚öñÔ∏è Auditoria Jur√≠dica <small style="font-size:0.6em; opacity:0.8; margin-left:10px; font-weight:normal;">v2.1 (Upload)</small></h1>
        <button class="btn-clear" onclick="limparMemoria()">Nova Conversa</button>
    </div>
    
    <div class="messages" id="messages">
        <div class="message bot">
            Ol√°! Sou seu assistente de auditoria jur√≠dica da DPE-BA.<br>
            Voc√™ pode fazer perguntas sobre a base de dados ou <strong>anexar um PDF (minuta/contrato)</strong> para eu analisar.
        </div>
    </div>
    
    <div class="loading" id="loader">Processando solicita√ß√£o...</div>

    <div class="footer-area">
        <!-- √Årea de preview do arquivo -->
        <div class="file-preview" id="filePreview">
            <span id="fileName">contrato.pdf</span>
            <button onclick="removerArquivo()" title="Remover arquivo">√ó</button>
        </div>

        <div class="input-row">
            <!-- Input de Arquivo (Escondido) -->
            <input type="file" id="fileInput" accept=".pdf" style="display: none;" onchange="arquivoSelecionado()">
            
            <!-- Bot√£o de Clipe -->
            <label for="fileInput" class="attach-btn" title="Anexar PDF">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                </svg>
            </label>

            <input type="text" id="userInput" placeholder="Digite sua pergunta ou pe√ßa uma an√°lise..." onkeypress="handleEnter(event)">
            <button onclick="enviarPergunta()" id="btnSend">Enviar</button>
        </div>
    </div>
</div>

<script>
    const API_BASE = (window.API_BASE ||
        ((location.hostname === 'localhost' || location.hostname === '127.0.0.1')
            ? 'http://localhost:3001'
            : 'https://normasdpe.onrender.com')
    ).replace(/\/$/, '');

    let conversationHistory = [];

    // --- FUN√á√ïES DE ARQUIVO ---
    function arquivoSelecionado() {
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('filePreview');
        const nameSpan = document.getElementById('fileName');

        if (fileInput.files.length > 0) {
            nameSpan.innerText = fileInput.files[0].name;
            preview.style.display = 'flex';
        }
    }

    function removerArquivo() {
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('filePreview');
        fileInput.value = ''; // Limpa o input
        preview.style.display = 'none';
    }

    // --- FUN√á√ïES DE CHAT ---
    async function enviarPergunta() {
        const input = document.getElementById('userInput');
        const fileInput = document.getElementById('fileInput');
        const btn = document.getElementById('btnSend');
        const loader = document.getElementById('loader');
        
        const pergunta = input.value.trim();
        const temArquivo = fileInput.files.length > 0;

        if (!pergunta && !temArquivo) return;

        // UI Updates
        let userMessage = pergunta;
        if (temArquivo) userMessage += ` <br><small>üìé Anexo: ${fileInput.files[0].name}</small>`;
        
        appendMessage(userMessage, 'user');
        
        input.value = '';
        input.disabled = true;
        btn.disabled = true;
        loader.style.display = 'flex';

        try {
            let textoDoArquivo = null;

            // 1. SE TIVER ARQUIVO, FAZ O UPLOAD PRIMEIRO
            if (temArquivo) {
                loader.innerText = "Lendo PDF anexado...";
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                const uploadRes = await fetch(`${API_BASE}/api/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadRes.ok) throw new Error("Erro ao ler PDF");
                
                const uploadData = await uploadRes.json();
                textoDoArquivo = uploadData.texto; // O texto extra√≠do do PDF
                
                // Feedback visual de que o PDF foi lido
                // appendMessage(`<i>PDF lido com sucesso (${uploadData.info}). Analisando...</i>`, 'bot');
            }

            // 2. ENVIA PERGUNTA + TEXTO DO ARQUIVO + HIST√ìRICO
            loader.innerText = "Consultando base jur√≠dica...";
            
            // Se o usu√°rio s√≥ mandou arquivo sem pergunta, definimos uma pergunta padr√£o
            const perguntaFinal = pergunta || "Fa√ßa uma an√°lise jur√≠dica deste documento anexado considerando as normas da DPE-BA.";

            const response = await fetch(`${API_BASE}/api/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    pergunta: perguntaFinal,
                    historico: conversationHistory,
                    contexto_arquivo: textoDoArquivo // <--- Aqui vai o texto do PDF
                })
            });

            const data = await response.json();
            
            appendMessage(data.resposta, 'bot', data.fontes);

            // Atualiza mem√≥ria
            conversationHistory.push({ role: "user", content: perguntaFinal });
            conversationHistory.push({ role: "assistant", content: data.resposta });

            // Limpa o arquivo ap√≥s envio
            removerArquivo();

        } catch (error) {
            console.error(error);
            appendMessage("‚ùå Erro ao processar. Verifique se o servidor (3001) est√° rodando e se o PDF √© leg√≠vel.", 'bot');
        } finally {
            input.disabled = false;
            btn.disabled = false;
            loader.style.display = 'none';
            input.focus();
        }
    }

    function appendMessage(text, sender, fontes = []) {
        const messagesDiv = document.getElementById('messages');
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        
        let htmlContent = text
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        if (fontes && fontes.length > 0) {
            htmlContent += `<div class="sources-box"><strong>üìö Fontes da Base DPE-BA:</strong><br>`;
            fontes.forEach(f => {
                htmlContent += `<span class="source-tag">${f}</span>`;
            });
            htmlContent += `</div>`;
        }

        div.innerHTML = htmlContent;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function limparMemoria() {
        conversationHistory = [];
        document.getElementById('messages').innerHTML = '<div class="message bot">Mem√≥ria limpa! Nova consulta iniciada.</div>';
        removerArquivo();
    }

    function handleEnter(e) { if (e.key === 'Enter') enviarPergunta(); }
</script>

</body>
</html>
